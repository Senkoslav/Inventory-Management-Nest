generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  USER
  ADMIN
}

enum FieldType {
  SINGLELINE
  MULTILINE
  NUMBER
  DOCUMENT
  BOOL
}

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  name      String
  avatarUrl String?
  roles     UserRole[] @default([USER])
  socialIds Json?
  createdAt DateTime @default(now())
  
  ownedInventories Inventory[]
  inventoryAccess  InventoryAccess[]
  createdItems     Item[]
  discussionPosts  DiscussionPost[]
  likes            Like[]
  
  @@map("users")
}

model Inventory {
  id          String   @id @default(uuid())
  ownerId     String
  title       String
  description String?
  category    String?
  imageUrl    String?
  isPublic    Boolean  @default(false)
  version     Int      @default(1)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  searchVector String?  @db.Text
  
  owner            User              @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  access           InventoryAccess[]
  fields           FieldDefinition[]
  items            Item[]
  tags             InventoryTag[]
  discussionPosts  DiscussionPost[]
  customIdSequence CustomIdSequence?
  
  @@index([ownerId])
  @@index([isPublic])
  @@map("inventories")
}

model InventoryAccess {
  id          String  @id @default(uuid())
  inventoryId String
  userId      String
  canWrite    Boolean @default(false)
  
  inventory Inventory @relation(fields: [inventoryId], references: [id], onDelete: Cascade)
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@unique([inventoryId, userId])
  @@index([userId])
  @@map("inventory_access")
}

model FieldDefinition {
  id          String    @id @default(uuid())
  inventoryId String
  position    Int
  type        FieldType
  title       String
  description String?
  showInTable Boolean   @default(true)
  constraints Json?
  
  inventory Inventory         @relation(fields: [inventoryId], references: [id], onDelete: Cascade)
  values    ItemFieldValue[]
  
  @@index([inventoryId])
  @@map("field_definitions")
}

model Item {
  id          String   @id @default(uuid())
  inventoryId String
  customId    String
  createdById String
  version     Int      @default(1)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  searchVector String?  @db.Text
  
  inventory   Inventory        @relation(fields: [inventoryId], references: [id], onDelete: Cascade)
  createdBy   User             @relation(fields: [createdById], references: [id])
  fieldValues ItemFieldValue[]
  likes       Like[]
  
  @@unique([inventoryId, customId])
  @@index([inventoryId])
  @@index([createdById])
  @@map("items")
}

model ItemFieldValue {
  id                String  @id @default(uuid())
  itemId            String
  fieldDefinitionId String?
  valueText         String?
  valueNumber       Float?
  valueBool         Boolean?
  valueLink         String?
  
  item            Item             @relation(fields: [itemId], references: [id], onDelete: Cascade)
  fieldDefinition FieldDefinition? @relation(fields: [fieldDefinitionId], references: [id], onDelete: Cascade)
  
  @@index([itemId])
  @@index([fieldDefinitionId])
  @@map("item_field_values")
}

model DiscussionPost {
  id           String   @id @default(uuid())
  inventoryId  String
  authorId     String
  markdownText String   @db.Text
  createdAt    DateTime @default(now())
  
  inventory Inventory @relation(fields: [inventoryId], references: [id], onDelete: Cascade)
  author    User      @relation(fields: [authorId], references: [id])
  
  @@index([inventoryId])
  @@index([authorId])
  @@map("discussion_posts")
}

model Like {
  id        String   @id @default(uuid())
  itemId    String
  userId    String
  createdAt DateTime @default(now())
  
  item Item @relation(fields: [itemId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@unique([itemId, userId])
  @@index([itemId])
  @@index([userId])
  @@map("likes")
}

model Tag {
  id   String @id @default(uuid())
  name String @unique
  
  inventories InventoryTag[]
  
  @@map("tags")
}

model InventoryTag {
  id          String @id @default(uuid())
  inventoryId String
  tagId       String
  
  inventory Inventory @relation(fields: [inventoryId], references: [id], onDelete: Cascade)
  tag       Tag       @relation(fields: [tagId], references: [id], onDelete: Cascade)
  
  @@unique([inventoryId, tagId])
  @@index([tagId])
  @@map("inventory_tags")
}

model CustomIdSequence {
  id          String @id @default(uuid())
  inventoryId String @unique
  template    Json
  nextValue   Int    @default(1)
  
  inventory Inventory @relation(fields: [inventoryId], references: [id], onDelete: Cascade)
  
  @@map("custom_id_sequences")
}
